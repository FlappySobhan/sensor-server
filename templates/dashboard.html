<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>داشبورد ابزار دقیق کشاورزی</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    :root {
      --primary: #2e7d32;
      --secondary: #1565c0;
      --danger: #d32f2f;
      --warning: #ed6c02;
      --light: #f5f5f5;
      --dark: #263238;
    }
    
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }
    
    body {
      background-color: #f8f9fa;
      color: #333;
      line-height: 1.6;
      padding: 20px;
    }
    
    .container {
      max-width: 1400px;
      margin: 0 auto;
    }
    
    h1, h2, h3 {
      color: var(--dark);
      margin-bottom: 20px;
    }
    
    h1 {
      text-align: center;
      padding: 15px;
      background: linear-gradient(to left, var(--primary), var(--secondary));
      color: white;
      border-radius: 10px;
      margin-bottom: 30px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }
    
    .cards {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }
    
    .card {
      background: white;
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.08);
      text-align: center;
      transition: transform 0.3s ease;
    }
    
    .card:hover {
      transform: translateY(-5px);
      box-shadow: 0 6px 12px rgba(0, 0, 0, 0.1);
    }
    
    .card h3 {
      font-size: 1rem;
      margin-bottom: 15px;
      color: var(--dark);
    }
    
    .big {
      font-size: 2.5rem;
      font-weight: bold;
    }
    
    #last-temp {
      color: var(--danger);
    }
    
    #last-hum {
      color: var(--secondary);
    }
    
    #last-soil {
      color: var(--primary);
    }
    
    .status-container {
      display: flex;
      justify-content: center;
      gap: 30px;
      margin: 30px 0;
    }
    
    .status {
      display: flex;
      flex-direction: column;
      align-items: center;
      background: white;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.08);
      min-width: 150px;
    }
    
    .status-icon {
      font-size: 2.5rem;
      margin-bottom: 10px;
    }
    
    .pump-on {
      color: var(--primary);
    }
    
    .pump-off {
      color: var(--danger);
    }
    
    .fan-on {
      color: var(--secondary);
    }
    
    .fan-off {
      color: #9e9e9e;
    }
    
    .chart-wrap {
      position: relative;
      height: 400px;
      margin-bottom: 40px;
      background: white;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.08);
    }
    
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
      background: white;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.08);
    }
    
    thead {
      background: linear-gradient(to left, var(--primary), var(--secondary));
      color: white;
    }
    
    th, td {
      padding: 15px;
      text-align: center;
      border-bottom: 1px solid #e0e0e0;
    }
    
    tr:last-child td {
      border-bottom: none;
    }
    
    tbody tr:hover {
      background-color: rgba(0, 0, 0, 0.02);
    }
    
    .last-update {
      text-align: left;
      margin-top: 20px;
      color: #757575;
      font-size: 0.9rem;
    }
    
    @media (max-width: 768px) {
      .cards {
        grid-template-columns: 1fr 1fr;
      }
      
      .status-container {
        flex-direction: column;
        align-items: center;
        gap: 15px;
      }
      
      .chart-wrap {
        height: 300px;
      }
    }
    
    @media (max-width: 480px) {
      .cards {
        grid-template-columns: 1fr;
      }
      
      .big {
        font-size: 2rem;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1><i class="fas fa-seedling"></i> داشبورد داده‌های سنسور کشاورزی</h1>
    
    <div class="cards">
      <div class="card">
        <h3>آخرین دما (°C)</h3>
        <div id="last-temp" class="big">--</div>
      </div>
      <div class="card">
        <h3>آخرین رطوبت (%)</h3>
        <div id="last-hum" class="big">--</div>
      </div>
      <div class="card">
        <h3>رطوبت خاک</h3>
        <div id="last-soil" class="big">--</div>
      </div>
      <div class="card">
        <h3>آخرین زمان</h3>
        <div id="last-ts" class="big">--</div>
      </div>
    </div>

    <div class="status-container">
      <div class="status">
        <div class="status-icon">
          <i id="pump-icon" class="fas fa-water-pump"></i>
        </div>
        <h3>وضعیت پمپ</h3>
        <div id="pump-status">غیرفعال</div>
      </div>
      
      <div class="status">
        <div class="status-icon">
          <i id="fan-icon" class="fas fa-fan"></i>
        </div>
        <h3>وضعیت فن</h3>
        <div id="fan-status">غیرفعال</div>
      </div>
    </div>

    <h2><i class="fas fa-chart-line"></i> نمودار تغییرات داده‌ها</h2>
    <div class="chart-wrap">
      <canvas id="lineChart"></canvas>
    </div>

    <h2><i class="fas fa-table"></i> آخرین رکوردها</h2>
    <table>
      <thead>
        <tr>
          <th>ID</th>
          <th>دما (°C)</th>
          <th>رطوبت (%)</th>
          <th>رطوبت خاک</th>
          <th>پمپ</th>
          <th>فن</th>
          <th>زمان</th>
        </tr>
      </thead>
      <tbody id="table-body">
        <tr>
          <td colspan="7">در حال بارگذاری داده‌ها...</td>
        </tr>
      </tbody>
    </table>
    
    <div class="last-update">
      آخرین بروزرسانی: <span id="update-time">--</span>
    </div>
  </div>

  <script>
    async function fetchData() {
      try {
        const res = await fetch('/all?limit=100');
        const data = await res.json();
        return data.reverse(); // oldest to newest for chart
      } catch (error) {
        console.error('Error fetching data:', error);
        return [];
      }
    }

    async function fetchLatest() {
      try {
        const res = await fetch('/latest');
        return await res.json();
      } catch (error) {
        console.error('Error fetching latest data:', error);
        return {};
      }
    }

    function renderTable(rows) {
      const tb = document.getElementById('table-body');
      if (rows.length === 0) {
        tb.innerHTML = '<tr><td colspan="7">هیچ داده‌ای یافت نشد</td></tr>';
        return;
      }
      
      tb.innerHTML = '';
      rows.slice().reverse().forEach(r => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${r.id}</td>
          <td>${r.temperature ?? '--'}</td>
          <td>${r.humidity ?? '--'}</td>
          <td>${r.soil_moisture ?? '--'}</td>
          <td>${r.pump_active ? 'فعال' : 'غیرفعال'}</td>
          <td>${r.fan_active ? 'فعال' : 'غیرفعال'}</td>
          <td>${r.timestamp ?? '--'}</td>
        `;
        tb.appendChild(tr);
      });
    }

    let chart;
    function renderChart(rows) {
      const ctx = document.getElementById('lineChart').getContext('2d');
      const labels = rows.map(r => r.timestamp);
      const temps = rows.map(r => r.temperature);
      const hums = rows.map(r => r.humidity);
      const soils = rows.map(r => r.soil_moisture);

      if (chart) chart.destroy();
      chart = new Chart(ctx, {
        type: 'line',
        data: {
          labels,
          datasets: [
            {
              label: 'دما (°C)',
              data: temps,
              borderColor: '#d32f2f',
              backgroundColor: 'rgba(211, 47, 47, 0.1)',
              tension: 0.3,
              yAxisID: 'y'
            },
            {
              label: 'رطوبت (%)',
              data: hums,
              borderColor: '#1565c0',
              backgroundColor: 'rgba(21, 101, 192, 0.1)',
              tension: 0.3,
              yAxisID: 'y'
            },
            {
              label: 'رطوبت خاک',
              data: soils,
              borderColor: '#2e7d32',
              backgroundColor: 'rgba(46, 125, 50, 0.1)',
              tension: 0.3,
              yAxisID: 'y1'
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          interaction: { mode: 'index', intersect: false },
          scales: {
            x: {
              display: true,
              title: { display: true, text: 'زمان' }
            },
            y: {
              display: true,
              title: { display: true, text: 'دما و رطوبت' },
              position: 'left'
            },
            y1: {
              display: true,
              title: { display: true, text: 'رطوبت خاک' },
              position: 'right',
              grid: {
                drawOnChartArea: false
              }
            }
          }
        }
      });
    }

    function updateStatusIndicator(pumpActive, fanActive) {
      const pumpStatus = document.getElementById('pump-status');
      const pumpIcon = document.getElementById('pump-icon');
      const fanStatus = document.getElementById('fan-status');
      const fanIcon = document.getElementById('fan-icon');
      
      // Update pump status
      if (pumpActive) {
        pumpStatus.textContent = 'فعال';
        pumpIcon.className = 'fas fa-water-pump pump-on';
      } else {
        pumpStatus.textContent = 'غیرفعال';
        pumpIcon.className = 'fas fa-water-pump pump-off';
      }
      
      // Update fan status
      if (fanActive) {
        fanStatus.textContent = 'فعال';
        fanIcon.className = 'fas fa-fan fan-on fa-spin';
      } else {
        fanStatus.textContent = 'غیرفعال';
        fanIcon.className = 'fas fa-fan fan-off';
      }
    }

    function updateLastUpdateTime() {
      const now = new Date();
      const timeString = now.toLocaleTimeString('fa-IR');
      const dateString = now.toLocaleDateString('fa-IR');
      document.getElementById('update-time').textContent = `${dateString} - ${timeString}`;
    }

    async function refresh() {
      const rows = await fetchData();
      renderTable(rows);
      renderChart(rows);

      const last = await fetchLatest();
      document.getElementById('last-temp').textContent = last.temperature ?? '--';
      document.getElementById('last-hum').textContent = last.humidity ?? '--';
      document.getElementById('last-soil').textContent = last.soil_moisture ?? '--';
      document.getElementById('last-ts').textContent = last.timestamp ?? '--';
      
      // Update pump and fan status
      updateStatusIndicator(last.pump_active, last.fan_active);
      
      // Update last update time
      updateLastUpdateTime();
    }

    // Initial load
    refresh();
    
    // Set interval for refreshing data
    setInterval(refresh, 10000); // refresh every 10s
    
    // Add animation to status icons on hover
    document.querySelectorAll('.status-icon').forEach(icon => {
      icon.addEventListener('mouseenter', function() {
        if (this.querySelector('.fan-on')) {
          this.querySelector('.fan-on').style.animation = 'spin 1s linear infinite';
        }
      });
      
      icon.addEventListener('mouseleave', function() {
        if (this.querySelector('.fan-on')) {
          this.querySelector('.fan-on').style.animation = '';
        }
      });
    });
  </script>
</body>
</html>